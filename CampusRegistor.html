<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CampusHub ‚Äì Register</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary: #5E35B1; --secondary: #7E57C2; --bg1: #f3e9fb; --bg2: #ede7f6;
  --muted: #6b7280; --text: #111; --card-bg: rgba(255,255,255,0.92);
  font-family: 'Poppins', sans-serif;
}
body.dark {
  --bg1:#1b132d; --bg2:#2a1f47; --text:#f3e9fb; --muted:#d1c4e9;
  --card-bg:rgba(46,34,72,0.9); --shadow:rgba(0,0,0,0.6);
}
body {
  margin: 0; color: var(--text); background: linear-gradient(120deg, var(--bg1), var(--bg2));
  overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column;
  position: relative; transition: background-color 0.3s, color 0.3s;
}
@keyframes float {
  from {transform: translateY(0) rotate(0);}
  to {transform: translateY(-40px) rotate(360deg);}
}
.bg-shape {
  position: absolute; border-radius: 50%; opacity: 0.3; filter: blur(50px);
  animation: float 10s ease-in-out infinite alternate;
}
.bg-shape.one { background: var(--primary); width: 200px; height: 200px; top: 20%; left: 5%; animation-delay: 0s; }
.bg-shape.two { background: var(--secondary); width: 260px; height: 260px; bottom: 10%; right: 10%; animation-delay: 2s; }
.bg-shape.three { background: #c084fc; width: 180px; height: 180px; top: 60%; left: 40%; animation-delay: 4s; }
header {
  height: 70px; background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff; display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; box-shadow: 0 6px 20px rgba(94,53,177,0.25);
  position: sticky; top: 0; z-index: 100;
}
.brand {
  display: flex; align-items: center; gap: 12px; font-weight: 600;
  font-size: 1.3rem; color: #fff; text-decoration: none;
}
header nav a {
  color: #fff; text-decoration: none; margin-left: 22px;
  font-weight: 500; opacity: 0.9; transition: opacity 0.3s;
}
header nav a:hover { opacity: 1; }
#themeToggle {
  cursor: pointer; font-size: 1.3rem; color: #fff; background: none;
  border: none; margin-left: 20px; transition: transform 0.3s;
}
#themeToggle:hover { transform: rotate(20deg); }
main {
  flex: 1; display: grid; grid-template-columns: 1fr 520px; align-items: center;
  max-width: 1200px; margin: 80px auto; padding: 0 20px; gap: 50px;
  position: relative; z-index: 5;
}
@media(max-width: 900px) {
  main { grid-template-columns: 1fr; text-align: center; margin: 40px 20px; }
  .left { margin-bottom: 30px; }
}
.left h1 { font-size: 38px; color: var(--primary); margin: 0; }
body.dark .left h1 { color: var(--secondary); }
.left p { color: var(--muted); font-size: 1rem; max-width: 55ch; line-height: 1.6; }
.features {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px; margin-top: 10px;
}
.feature {
  display: flex; align-items: center; gap: 12px; background: var(--card-bg);
  border-radius: 16px; padding: 14px; border: 1px solid var(--border-color);
  box-shadow: 0 10px 25px rgba(94,53,177,0.1);
  transition: transform 0.3s, box-shadow 0.3s;
}
body.dark .feature {
    background: rgba(46,34,72,0.8);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.feature:hover {
  transform: translateY(-5px);
  box-shadow: 0 14px 35px rgba(94,53,177,0.25);
}
.feature .icon {
  width: 46px; height: 46px; background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff; border-radius: 12px; display: flex; align-items: center;
  justify-content: center; font-size: 1.2rem;
}
.feature div { color: var(--text); }
.card {
  position: relative; background: var(--card-bg); border-radius: 20px;
  padding: 40px 36px; box-shadow: 0 20px 50px rgba(94,53,177,0.2);
  backdrop-filter: blur(12px); overflow: hidden; border: 1px solid var(--border-color);
}
body.dark .card { box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
.card h2 { color: var(--primary); margin-bottom: 8px; }
body.dark .card h2 { color: var(--secondary); }
.card p { color: var(--muted); margin-bottom: 18px; }
form { display: flex; flex-direction: column; gap: 18px; }
.input-group { position: relative; }
input, select {
  width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd;
  font-size: 0.95rem; background: var(--bg1); color: var(--text);
  transition: 0.3s; font-family: 'Poppins', sans-serif;
}
body.dark input, body.dark select { border-color: #4a3a6b; background: var(--bg1); }
input:focus, select:focus {
  border-color: var(--primary); box-shadow: 0 0 10px rgba(94,53,177,0.3);
  outline: none; background: var(--card-bg);
}
label {
  position: absolute; left: 14px; top: 14px; color: var(--muted);
  pointer-events: none; transition: 0.3s ease; background: var(--bg1); padding: 0 6px;
}
body.dark label { background: var(--bg1); }
/* Fix for floating label on select */
input:focus + label, input:not(:placeholder-shown) + label,
select:focus + label, select:valid + label {
  top: -9px; font-size: 12px; color: var(--primary); background: var(--card-bg);
}
body.dark input:focus + label, body.dark input:not(:placeholder-shown) + label,
body.dark select:focus + label, body.dark select:valid + label {
    background: var(--bg2);
}

button[type="submit"] {
  margin-top: 8px; background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff; border: none; border-radius: 12px; padding: 14px;
  font-weight: 600; cursor: pointer; transition: all 0.3s;
  box-shadow: 0 8px 22px rgba(94,53,177,0.25);
  font-family: 'Poppins', sans-serif; font-size: 1rem;
}
button[type="submit"]:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 28px rgba(94,53,177,0.35); 
}
button[type="submit"]:disabled {
    background: var(--muted);
    cursor: not-allowed;
}
#message {
    text-align: center; font-weight: 500;
    margin-top: 15px; font-size: 0.95rem;
}
.links { text-align: center; margin-top: 20px; color: var(--muted); font-size: 0.9rem; }
.links a { color: var(--primary); font-weight: 600; text-decoration: none; }
.links a:hover { text-decoration: underline; }
footer { text-align: center; color: var(--muted); font-size: 0.85rem; padding: 14px 0 20px; }
canvas#particles {
  position: fixed; top: 0; left: 0; z-index: 0;
  width: 100%; height: 100%; pointer-events: none;
}
</style>
</head>

<body>
<canvas id="particles"></canvas>
<div class="bg-shape one"></div>
<div class="bg-shape two"></div>
<div class="bg-shape three"></div>

<header>
  <a href="CampusRegistor.html" class="brand"><i class="fa-solid fa-graduation-cap"></i> CampusHub</a>
  <nav>

    <a href="index.html">Login</a>
    <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>
  </nav>
</header>

<main>
  <section class="left">
    <h1>Join CampusHub</h1>
    <p>Register today and become part of your digital campus ‚Äî collaborate with classmates, stay informed, and explore opportunities together.</p>
    <div class="features">
      <div class="feature"><div class="icon"><i class="fa-solid fa-calendar-check"></i></div><div>Discover campus events.</div></div>
      <div class="feature"><div class="icon"><i class="fa-solid fa-users"></i></div><div>Find teammates and groups.</div></div>
      <div class="feature"><div class="icon"><i class="fa-solid fa-comments"></i></div><div>Join campus discussions.</div></div>
      <div class="feature"><div class="icon"><i class="fa-solid fa-handshake"></i></div><div>Collaborate on projects.</div></div>
    </div>
  </section>

  <section class="card">
    <h2>Create Your Account</h2>
    <p>Fill in the fields below to get started.</p>

    <!-- FIXED: Added form ID -->
    <form id="registerForm">
      <div class="input-group">
        <input type="text" id="fullname" placeholder=" " required>
        <label for="fullname">Full Name</label>
      </div>
      <div class="input-group">
  <select id="role" required>
    <option value="student">Student</option>
    <option value="teacher">Teacher</option>
    <option value="admin">Admin</option>
  </select>
  <label for="role">Role</label>
</div>

      <div class="input-group">
        <input type="email" id="email" placeholder=" " required>
        <label for="email">College Email</label>
      </div>
      
      <!-- NEW: Dynamic Department Select -->
      <div class="input-group">
        <select id="dept" required>
          <option value="" disabled selected hidden>Loading departments...</option>
          <!-- Departments will be loaded here by JavaScript -->
        </select>
        <label for="dept">Department</label>
      </div>
      
      <div class="input-group">
        <select id="year" required>
          <option value="" disabled selected hidden></option>
          <option value="FY">FY</option>
          <option value="SY">SY</option>
          <option value="TY">TY</option>
          <option value="Final Year">Final Year</option>
        </select>
        <label for="year">Year</label>
      </div>
      <div class="input-group">
        <input type="password" id="password" placeholder=" " required>
        <label for="password">Password</label>
      </div>
      <div class="input-group">
        <input type="password" id="confirm" placeholder=" " required>
        <label for="confirm">Confirm Password</label>
      </div>
      <button type="submit" id="registerBtn">Register</button>
    </form>
    
    <!-- FIXED: Added message paragraph -->
    <p id="message"></p>

    <div class="links">
      Already have an account? <a href="index.html">Login here</a>
    </div>
  </section>
</main>

<footer>¬© 2025 CampusHub | Designed for Connected Campuses üíú</footer>

<script>
  // === 1. SUPABASE CLIENT INITIALIZATION ===
   const SUPABASE_URL = "https://tuucgqbyegerndyviefw.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1dWNncWJ5ZWdlcm5keXZpZWZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTc1NTksImV4cCI6MjA3NzEzMzU1OX0.fImUoHr86_5MdkDEWu8JXhjSaG2oxbq0IoGhZ6XeH-0";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


  const form = document.getElementById("registerForm");
  const msg = document.getElementById("message");
  const registerBtn = document.getElementById("registerBtn");
  const deptSelect = document.getElementById("dept");

  function setStatus(text, isError = false) {
      msg.textContent = text;
      msg.style.color = isError ? 'red' : (isError === null ? 'var(--text-light)' : 'green');
  }

  // === 2. DYNAMICALLY LOAD DEPARTMENTS ===
  async function loadDepartments() {
    if (!supabaseClient) {
        deptSelect.innerHTML = '<option value="">Could not load departments</option>';
        return;
    }
    
    const { data, error } = await supabaseClient
      .from('departments')
      .select('dept_id, dept_name');
      
    if (error) {
      console.error("Error loading departments:", error);
      deptSelect.innerHTML = '<option value="">Error loading departments</option>';
    } else {
      // Clear the "Loading..." text
      deptSelect.innerHTML = '<option value="" disabled selected hidden>-- Select your department --</option>';
      data.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.dept_id; // Use the ID as the value
        option.textContent = dept.dept_name; // Show the name to the user
        deptSelect.appendChild(option);
      });
    }
  }

  // === 3. HANDLE REGISTRATION ===
  if (form && supabaseClient) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fullname = document.getElementById("fullname").value.trim();
        const email = document.getElementById("email").value.trim();
        const dept_id = document.getElementById("dept").value; // This is now the ID
        const year = document.getElementById("year").value;
        const password = document.getElementById("password").value;
        const confirm = document.getElementById("confirm").value;

        if (password !== confirm) {
          setStatus("‚ö†Ô∏è Passwords do not match!", true);
          return;
        }
        
        if (!dept_id) {
            setStatus("‚ö†Ô∏è Please select your department.", true);
            return;
        }

        setStatus("‚è≥ Registering...", null);
        registerBtn.disabled = true;
        registerBtn.textContent = "Registering...";

        // NEW: Pass all metadata to the signUp function
        // This metadata will be read by your SQL trigger
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
  user_name: fullname,
  year: year,
  department_id: dept_id,
  role: document.getElementById("role").value
}

          }
        });

        if (error) {
          setStatus("‚ùå " + error.message, true);
        } else {
          setStatus("‚úÖ Registration successful! Please check your email for verification.", false);
          form.reset();
          setTimeout(() => {
              window.location.href = 'index.html'; // Redirect to login
          }, 3000);
        }
        
        registerBtn.disabled = false;
        registerBtn.textContent = "Register";
      });
  } else if (form) {
      form.addEventListener("submit", (e) => {
          e.preventDefault();
          setStatus("‚ö†Ô∏è Registration is disabled. Supabase keys not set.", true);
      });
  }
  
  // === 4. RUN ON PAGE LOAD ===
  loadDepartments(); // Fetch departments as soon as the page loads
</script>
  
<script>
// üåô DARK / LIGHT MODE
const themeBtn = document.getElementById('themeToggle');
const body = document.body;
if (localStorage.getItem('theme') === 'dark') {
  body.classList.add('dark');
  if(themeBtn) themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
} else {
    if(themeBtn) themeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
}

if(themeBtn) {
    themeBtn.onclick = () => {
      body.classList.toggle('dark');
      if (body.classList.contains('dark')) {
        themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
        localStorage.setItem('theme', 'dark');
      } else {
        themeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
        localStorage.setItem('theme', 'light');
      }
      // Redraw particles with new color
      if(window.drawParticles) window.drawParticles(true);
    };
}

// ‚ú® PARTICLES WITH MOUSE INTERACTION
const canvas = document.getElementById('particles');
if (canvas) {
    const ctx = canvas.getContext('2d');
    let particles = [];
    const particleCount = 70;
    let mouse = { x: 0, y: 0 };

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    window.addEventListener('mousemove', e => {
      mouse.x = e.clientX;
      mouse.y = e.clientY;
    });

    for (let i = 0; i < particleCount; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 3 + 1,
        dx: (Math.random() - 0.5) * 0.7,
        dy: (Math.random() - 0.5) * 0.7,
      });
    }

    // Make drawParticles global so theme toggle can call it
    window.drawParticles = (forceRedraw = false) => {
      if(!ctx) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = document.body.classList.contains('dark') ? '#b39ddb' : '#7E57C2';
      
      particles.forEach(p => {
        if(!forceRedraw) {
            let dx = mouse.x - p.x;
            let dy = mouse.y - p.y;
            let dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 100) { // This makes them run from the mouse
              p.x -= dx / 40;
              p.y -= dy / 40;
            }
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
        
        if(!forceRedraw) {
            p.x += p.dx;
            p.y += p.dy;
            if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
            if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
        }
      });
      
      if(!forceRedraw) {
        requestAnimationFrame(window.drawParticles);
      }
    }
    // Start the animation loop
    window.drawParticles();
}
</script>
</body>
</html>