<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CampusHub ‚Äì My Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === DESIGN SYSTEM === */
:root {
  --primary: #5E35B1; --primary-grad: linear-gradient(135deg, #7E57C2, #5E35B1);
  --bg1: #f3e9fb; --bg2: #ede7f6; --card: #ffffff;
  --text: #333; --text-light: #555; --border: #e0e0e0;
  --chip-bg: #ede7f6; --chip-text: #5E35B1;
}
body.dark {
  --bg1: #1b132d; --bg2: #2a1f47; --card: #2a1f47;
  --text: #f3e9fb; --text-light: #d1c4e9; --border: #4a3a6b;
  --chip-bg: #3b2d5f; --chip-text: #b39ddb;
}
body {
  font-family: 'Poppins', sans-serif; background: linear-gradient(120deg, var(--bg1), var(--bg2));
  color: var(--text); margin: 0; padding-top: 70px; transition: 0.4s; min-height: 100vh;
}

/* HEADER */
header{height:70px;background:var(--primary-grad);color:#fff;display:flex;justify-content:space-between;align-items:center;padding:0 28px;position:fixed;top:0;width:100%;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,0.2);box-sizing:border-box;}
.nav-logo{font-size:1.5rem;font-weight:700;color:#fff;text-decoration:none;display:flex;align-items:center;gap:10px;}
.nav-menu{display:flex;gap:15px;}
.nav-link{text-decoration:none;color:#fff;opacity:0.9;padding:10px;transition:0.3s;}
.nav-link:hover,.nav-link.active{opacity:1;border-bottom:3px solid #fff;}
.nav-user{display:flex;align-items:center;gap:15px;}
#themeToggle,#logout-btn{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:0.3s;}
#themeToggle:hover{transform:rotate(20deg);}

/* PROFILE MAIN */
main { max-width: 800px; margin: 40px auto; padding: 0 20px; padding-bottom: 60px; }

/* PROFILE BANNER & HEADER */
.profile-header { position: relative; margin-bottom: 60px; }
.banner {
    height: 160px;
    background: var(--primary-grad);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(94, 53, 177, 0.3);
}
.profile-pic-wrapper {
    position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%);
    width: 140px; height: 140px;
}
.profile-pic {
    width: 100%; height: 100%; border-radius: 50%; border: 5px solid var(--card);
    object-fit: cover; background: var(--card);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: 0.3s;
}
.pic-edit-overlay {
    position: absolute; inset: 5px; background: rgba(0,0,0,0.5); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #fff;
    font-size: 1.5rem; opacity: 0; transition: 0.3s; cursor: pointer;
}
.profile-pic-wrapper:hover .pic-edit-overlay { opacity: 1; }

/* FORM CARD */
.card {
    background: var(--card); border-radius: 20px; padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid var(--border);
    animation: slideUp 0.5s ease;
}
@keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

h2 { color: var(--primary); text-align: center; margin-bottom: 10px; }
h3.section-title { font-size: 1.1rem; color: var(--text); margin: 25px 0 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
body.dark h2 { color: #9FA8DA; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

.form-group { margin-bottom: 15px; position: relative; }
.form-group.full-width { grid-column: 1 / -1; }
label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); font-size: 0.9rem; }

/* INPUTS */
.input-wrapper { position: relative; }
.input-wrapper i {
    position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
    color: var(--primary); opacity: 0.7; pointer-events: none;
}
input, select, textarea {
    width: 100%; padding: 14px 14px 14px 45px; border-radius: 12px;
    border: 2px solid var(--border); background: var(--bg1); color: var(--text);
    font-family: inherit; font-size: 1rem; transition: 0.3s; box-sizing: border-box;
}
textarea { padding: 14px; min-height: 100px; resize: vertical; }
input:focus, select:focus, textarea:focus {
    border-color: var(--primary); background: var(--card); outline: none;
    box-shadow: 0 0 0 4px rgba(94, 53, 177, 0.1);
}
input:disabled { opacity: 0.7; cursor: not-allowed; }

/* INTERESTS CHIPS */
.chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
.chip-checkbox { display: none; }
.chip-label {
    padding: 8px 18px; background: var(--bg1); border: 2px solid var(--border);
    border-radius: 50px; font-size: 0.9rem; font-weight: 500; color: var(--text-light);
    cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
}
.chip-label:hover { border-color: var(--primary); color: var(--primary); }
.chip-checkbox:checked + .chip-label {
    background: var(--primary); border-color: var(--primary); color: #fff;
    box-shadow: 0 4px 10px rgba(94, 53, 177, 0.3);
}

/* BUTTONS */
.save-btn {
    width: 100%; padding: 15px; background: var(--primary-grad); color: #fff;
    border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
    cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(94, 53, 177, 0.3);
    display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px;
}
.save-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(94, 53, 177, 0.4); }
.save-btn:disabled { opacity: 0.7; cursor: wait; }

/* TOAST */
#toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--text); color: var(--card); padding: 12px 25px; border-radius: 50px;
    font-weight: 600; opacity: 0; transition: 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1000;
}
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
#toast.success { background: #4CAF50; color: #fff; }
#toast.error { background: #f44336; color: #fff; }

</style>
</head>
<body>

<header>
  <a href="campushub.html" class="nav-logo"><i class="fa-solid fa-graduation-cap"></i> CampusHub</a>
  <nav class="nav-menu">
    <a href="campushub.html" class="nav-link">Home</a>
    <a href="CampusLostdyanmic.html" class="nav-link">Lost & Found</a>
    <a href="Teamup.html" class="nav-link">Team Up</a>
    <a href="event.html" class="nav-link">Events</a>
    <a href="qa_with_answers_share_answer.html" class="nav-link">Q&A</a>
    <a href="contact.html" class="nav-link">Contact</a>
  </nav>
  <div class="nav-user">
    <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>
    <button id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
  </div>
</header>

<main>
    <div class="profile-header">
        <div class="banner"></div>
        <div class="profile-pic-wrapper">
            <img src="https://placehold.co/150/5E35B1/fff?text=..." id="profile-preview" class="profile-pic" alt="Profile">
            <label for="pic-input" class="pic-edit-overlay">
                <i class="fa-solid fa-camera"></i>
            </label>
            <input type="file" id="pic-input" accept="image/*" style="display:none;"> 
        </div>
    </div>

    <section class="card">
        <h2>Edit Profile</h2>
        <form id="profile-form">
            
            <!-- Basic Details -->
            <div class="form-grid">
                <div class="form-group">
                    <label>Full Name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="fullname" required placeholder="John Doe">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" disabled placeholder="email@college.edu">
                    </div>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <div class="input-wrapper">
                        <i class="fas fa-building-columns"></i>
                        <!-- Dynamically populated from 'departments' table -->
                        <select id="dept" required>
                            <option value="" disabled selected>Loading departments...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Year</label>
                    <div class="input-wrapper">
                        <i class="fas fa-calendar-alt"></i>
                        <select id="year" required>
                            <option value="" disabled selected>Select Year</option>
                            <option value="1st Year">1st Year (FY)</option>
                            <option value="2nd Year">2nd Year (SY)</option>
                            <option value="3rd Year">3rd Year (TY)</option>
                            <option value="4th Year">4th Year (Final)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- About Me -->
            <div class="form-group full-width">
                <label>About Me (Bio)</label>
                <textarea id="bio" placeholder="Tell us a little about yourself..."></textarea>
            </div>

            <!-- Interests Section -->
            <h3 class="section-title">Interests & Skills</h3>
            <div class="form-group full-width">
                <label>Select your interests</label>
                <div class="chip-container">
                    <input type="checkbox" id="chk-coding" class="chip-checkbox" value="Coding">
                    <label for="chk-coding" class="chip-label">üíª Coding</label>

                    <input type="checkbox" id="chk-design" class="chip-checkbox" value="Design">
                    <label for="chk-design" class="chip-label">üé® Design</label>

                    <input type="checkbox" id="chk-sports" class="chip-checkbox" value="Sports">
                    <label for="chk-sports" class="chip-label">‚öΩ Sports</label>

                    <input type="checkbox" id="chk-music" class="chip-checkbox" value="Music">
                    <label for="chk-music" class="chip-label">üéµ Music</label>

                    <input type="checkbox" id="chk-gaming" class="chip-checkbox" value="Gaming">
                    <label for="chk-gaming" class="chip-label">üéÆ Gaming</label>

                    <input type="checkbox" id="chk-photo" class="chip-checkbox" value="Photography">
                    <label for="chk-photo" class="chip-label">üì∑ Photography</label>
                </div>
                <div class="input-wrapper" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i>
                    <input type="text" id="other-interests" placeholder="Other interests (comma separated, e.g. Chess, Debate)">
                </div>
            </div>

            <!-- Social Links Section -->
            <h3 class="section-title">Social Links</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>LinkedIn</label>
                    <div class="input-wrapper">
                        <i class="fa-brands fa-linkedin"></i>
                        <input type="url" id="social-linkedin" data-platform="LinkedIn" placeholder="https://linkedin.com/in/...">
                    </div>
                </div>
                <div class="form-group">
                    <label>GitHub</label>
                    <div class="input-wrapper">
                        <i class="fa-brands fa-github"></i>
                        <input type="url" id="social-github" data-platform="GitHub" placeholder="https://github.com/...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Instagram</label>
                    <div class="input-wrapper">
                        <i class="fa-brands fa-instagram"></i>
                        <input type="url" id="social-instagram" data-platform="Instagram" placeholder="https://instagram.com/...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Portfolio / Website</label>
                    <div class="input-wrapper">
                        <i class="fas fa-globe"></i>
                        <input type="url" id="social-website" data-platform="Website" placeholder="https://yourportfolio.com">
                    </div>
                </div>
            </div>

            <button type="submit" id="save-btn" class="save-btn">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </section>
</main>

<div id="toast">Profile updated!</div>

<script>
    const SUPABASE_URL = 'https://tuucgqbyegerndyviefw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1dWNncWJ5ZWdlcm5keXZpZWZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTc1NTksImV4cCI6MjA3NzEzMzU1OX0.fImUoHr86_5MdkDEWu8JXhjSaG2oxbq0IoGhZ6XeH-0';
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;

    // UUID Generator Polyfill (for environments where crypto.randomUUID is restricted)
    function generateUUID() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // === 1. INIT & LOAD ===
    async function init() {
        // Auth check
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return window.location.href = 'index.html';
        currentUser = session.user;
        
        // Load dependencies and profile
        await loadDepartments();
        await loadProfileData();
    }

    // Load Departments from 'departments' table for FK relationship
    async function loadDepartments() {
        const { data: depts, error } = await supabase.from('departments').select('*').order('dept_name');
        const select = document.getElementById('dept');
        select.innerHTML = '<option value="" disabled selected>Select Department</option>';
        
        if (depts && depts.length > 0) {
            depts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.dept_id; // Using bigint ID
                opt.textContent = d.dept_name;
                select.appendChild(opt);
            });
        } else {
            // Fallback if table is empty
            const fallbacks = ["Computer Science", "Information Tech", "Electronics", "Mechanical", "Civil"];
            fallbacks.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = i + 1; 
                opt.textContent = d;
                select.appendChild(opt);
            });
        }
    }

    async function loadProfileData() {
        document.getElementById('email').value = currentUser.email;

        // 1. Fetch from 'users' table (Core Data)
        const { data: userData } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
        
        if (userData) {
            document.getElementById('fullname').value = userData.user_name || '';
            document.getElementById('year').value = userData.year || '';
            if (userData.dep_id) document.getElementById('dept').value = userData.dep_id;
            
            const initial = (userData.user_name || currentUser.email || 'U')[0].toUpperCase();
            const avatarUrl = userData.user_avatar || `https://placehold.co/150/5E35B1/fff?text=${initial}`;
            document.getElementById('profile-preview').src = avatarUrl;
        }

        // 2. Fetch from 'user_profiles' table (Bio)
        const { data: profileData } = await supabase.from('user_profiles').select('bio').eq('user_id', currentUser.id).maybeSingle();
        if (profileData && profileData.bio) {
            document.getElementById('bio').value = profileData.bio;
        }

        // 3. Fetch from 'user_interests' table
        const { data: interests } = await supabase.from('user_interests').select('interest_name').eq('user_id', currentUser.id);
        if (interests) {
            const interestNames = interests.map(i => i.interest_name);
            
            // Check chips
            document.querySelectorAll('.chip-checkbox').forEach(chk => {
                if (interestNames.includes(chk.value)) {
                    chk.checked = true;
                }
            });

            // Add non-chip interests to text box
            const standardValues = Array.from(document.querySelectorAll('.chip-checkbox')).map(c => c.value);
            const otherValues = interestNames.filter(i => !standardValues.includes(i));
            document.getElementById('other-interests').value = otherValues.join(', ');
        }

        // 4. Fetch from 'user_social_link' table
        const { data: socials } = await supabase.from('user_social_link').select('*').eq('user_id', currentUser.id);
        if (socials) {
            socials.forEach(link => {
                if(link.platform_name === 'LinkedIn') document.getElementById('social-linkedin').value = link.url;
                if(link.platform_name === 'GitHub') document.getElementById('social-github').value = link.url;
                if(link.platform_name === 'Instagram') document.getElementById('social-instagram').value = link.url;
                if(link.platform_name === 'Website') document.getElementById('social-website').value = link.url;
            });
        }
    }

    // === 2. INSTANT IMAGE PREVIEW ===
    document.getElementById('pic-input').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('profile-preview').src = URL.createObjectURL(file);
        }
    };

    // === 3. SAVE HANDLER ===
    document.getElementById('profile-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
            // A. Handle Image Upload
            let avatarUrl = document.getElementById('profile-preview').src;
            const picFile = document.getElementById('pic-input').files[0];
            
            // Only upload if a NEW file is selected (src is blob:...)
            if (picFile) {
                const path = `avatars/${currentUser.id}/${Date.now()}.png`;
                const { error: upErr } = await supabase.storage.from('avatars').upload(path, picFile, { upsert: true });
                if (upErr) throw upErr;
                const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(path);
                avatarUrl = publicUrl;
            }

            // B. Update 'users' table (Core Info)
            const userName = document.getElementById('fullname').value;
            const deptId = document.getElementById('dept').value;
            const year = document.getElementById('year').value;

            const { error: userErr } = await supabase.from('users').upsert({
                id: currentUser.id,
                user_name: userName,
                email: currentUser.email,
                user_avatar: avatarUrl,
                dep_id: deptId,
                year: year
            });
            if (userErr) throw userErr;

            // C. Update 'user_profiles' table (Bio)
            // FIX: 'upsert' with 'onConflict: user_id' fails if user_id is not a unique constraint.
            // SOLUTION: Check if exists, then Update or Insert.
            const bio = document.getElementById('bio').value;
            
            const { data: existingProfile } = await supabase.from('user_profiles')
                .select('profile_id')
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (existingProfile) {
                const { error: updateErr } = await supabase.from('user_profiles')
                    .update({ bio: bio, profile_image: avatarUrl })
                    .eq('user_id', currentUser.id);
                if (updateErr) throw updateErr;
            } else {
                const { error: insertErr } = await supabase.from('user_profiles')
                    .insert({ user_id: currentUser.id, bio: bio, profile_image: avatarUrl });
                if (insertErr) throw insertErr;
            }

            // D. Update 'user_interests' (Delete All -> Insert New)
            await supabase.from('user_interests').delete().eq('user_id', currentUser.id);
            
            const selectedChips = Array.from(document.querySelectorAll('.chip-checkbox:checked')).map(c => c.value);
            const otherText = document.getElementById('other-interests').value.split(',').map(s => s.trim()).filter(s => s);
            const finalInterests = [...new Set([...selectedChips, ...otherText])];

            if (finalInterests.length > 0) {
                const interestInserts = finalInterests.map(i => ({
                    interest_id: generateUUID(), // Use Helper Function
                    user_id: currentUser.id,
                    interest_name: i
                }));
                const { error: intErr } = await supabase.from('user_interests').insert(interestInserts);
                if (intErr) throw intErr;
            }

            // E. Update 'user_social_link' (Delete All -> Insert New)
            await supabase.from('user_social_link').delete().eq('user_id', currentUser.id);

            const socialInputs = [
                { id: 'social-linkedin', platform: 'LinkedIn' },
                { id: 'social-github', platform: 'GitHub' },
                { id: 'social-instagram', platform: 'Instagram' },
                { id: 'social-website', platform: 'Website' }
            ];

            const socialInserts = [];
            socialInputs.forEach(item => {
                const url = document.getElementById(item.id).value.trim();
                if (url) {
                    socialInserts.push({
                        user_id: currentUser.id,
                        platform_name: item.platform,
                        url: url
                    });
                }
            });

            if (socialInserts.length > 0) {
                const { error: socErr } = await supabase.from('user_social_link').insert(socialInserts);
                if (socErr) throw socErr;
            }

            showToast('‚úÖ Profile updated successfully!', 'success');

        } catch (err) {
            console.error("Save Error:", err);
            showToast('‚ùå Error saving profile: ' + err.message, 'error');
        } finally {
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
    };

    // === UTILS ===
    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = type + ' show';
        setTimeout(() => t.className = '', 3000);
    }
    
    document.getElementById('themeToggle').onclick = () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    };
    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
    document.getElementById('logout-btn').onclick = async () => { await supabase.auth.signOut(); window.location.href = 'index.html'; };

const themeBtn = document.getElementById('themeToggle');
    const body = document.body;
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
    }
    themeBtn.onclick = () => {
      body.classList.toggle("dark");
      const isDark = body.classList.contains("dark");
      themeBtn.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
      localStorage.setItem("theme", isDark ? 'dark' : 'light');
    };

    init();
</script>
</body>
</html>

